import{p as V,a4 as $,a as S,u as H,ag as R,r as c,j as e,C as v,f as C,ao as N,B as Y,c as D,d as Z,ah as q,ai as z,aj as W,G as K,D as Q,h as X,i as ee,k as ne,l as se}from"./index-Caw7KGCA.js";import{u as ae,c as te}from"./useChallenges-MXcyjD6y.js";import{U as le}from"./users-Bala6d7Y.js";import{C as ie}from"./circle-check-big-BCGySWHe.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=V("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]);function oe(){const[n]=$(),s=S(),{user:t}=H(),{joinChallengeByToken:d,activeChallenge:m,refetch:x}=ae(),{toast:i}=R(),[u,f]=c.useState(null),[j,y]=c.useState(!0),[T,b]=c.useState(!1),[O,w]=c.useState(!1),[G,_]=c.useState(""),[U,F]=c.useState(5),[B,r]=c.useState(""),h=n.get("token"),M=async()=>{if(!(!h||!t))try{y(!0),r("ðŸ” Starting challenge validation..."),console.log("ðŸ” CHALLENGE JOIN: Fetching challenge for join with token:",h),console.log("ðŸ” CHALLENGE JOIN: Current user ID:",t.id);const a=await te.validateChallengeToken(h);if(!a){console.log("âŒ CHALLENGE JOIN: No valid challenge found for token"),r("âŒ Challenge validation failed - not found or expired"),i({title:"Challenge Not Available",description:"This challenge link is invalid, has expired, or has already been joined by someone else.",variant:"destructive"}),s("/challenges");return}if(console.log("âœ… CHALLENGE JOIN: Valid challenge found:",{id:a.id,status:a.status,challenger_id:a.challenger_id,opponent_id:a.opponent_id,current_user:t.id}),f(a),r(`âœ… Challenge found: ${a.id}, Status: ${a.status}`),a.challenger_id===t.id){r("âš ï¸ User is the challenger - cannot join own challenge"),i({title:"Cannot Join Own Challenge",description:"You cannot join a challenge that you created. Share this link with someone else!",variant:"destructive"}),s("/challenges");return}if(m){r("âš ï¸ User already has active challenge"),i({title:"Active Challenge",description:"You already have an active challenge. Complete it before joining a new one!",variant:"destructive"}),s("/challenges");return}r("ðŸš€ Proceeding to join challenge..."),await P(h,a)}catch(a){console.error("ðŸ’¥ CHALLENGE JOIN: Error fetching challenge:",a),r(`ðŸ’¥ Error: ${a instanceof Error?a.message:"Unknown error"}`),i({title:"Error",description:"Failed to load challenge details.",variant:"destructive"}),s("/challenges")}finally{y(!1)}},P=async(a,o)=>{var E,L,J,k,I,A;if(t){b(!0),r("ðŸ”„ Attempting to join challenge...");try{console.log("ðŸ”„ CHALLENGE JOIN: Attempting to join challenge with token:",a),console.log("ðŸ”„ CHALLENGE JOIN: User ID:",t.id);const l=await d(a,t.id);if(console.log("ðŸ”„ CHALLENGE JOIN: Join challenge result:",l),l.success){r("ðŸŽ‰ Challenge joined successfully!");const g=((E=o==null?void 0:o.challenger_profile)==null?void 0:E.name)||((L=o==null?void 0:o.challenger_profile)==null?void 0:L.username)||"Challenge";_(g),F((o==null?void 0:o.challenge_length)||5),console.log("ðŸŽ‰ CHALLENGE JOIN: Success! Showing modal and refreshing data..."),w(!0),await x(),setTimeout(()=>{console.log("ðŸ”„ CHALLENGE JOIN: Redirecting to challenges page..."),w(!1),s("/challenges")},3e3)}else{console.log("âŒ CHALLENGE JOIN: Join failed with error:",l.error),r(`âŒ Join failed: ${l.error}`);let g=l.error||"Failed to join the challenge.",p="Join Failed";(J=l.error)!=null&&J.includes("already joined")?(p="Challenge Full",g="Someone else has already joined this challenge. Try creating your own!"):(k=l.error)!=null&&k.includes("own challenge")?(p="Cannot Join Own Challenge",g="You cannot join a challenge you created. Share the link with someone else!"):(I=l.error)!=null&&I.includes("already have an active challenge")?(p="Active Challenge",g="Complete your current challenge before joining a new one."):(A=l.error)!=null&&A.includes("expired")&&(p="Challenge Expired",g="This challenge invitation has expired. Ask for a new invite link."),i({title:p,description:g,variant:"destructive"}),s("/challenges")}}catch(l){console.error("ðŸ’¥ CHALLENGE JOIN: Error joining challenge:",l),r(`ðŸ’¥ Exception: ${l instanceof Error?l.message:"Unknown error"}`),i({title:"Error",description:"An unexpected error occurred while joining the challenge.",variant:"destructive"}),s("/challenges")}finally{b(!1)}}};return{inviteToken:h,challenge:u,isLoading:j,isJoining:T,showSuccessModal:O,joinedChallengeName:G,challengeDays:U,debugInfo:B,handleTokenValidation:()=>{if(!h){console.log("âŒ CHALLENGE JOIN: No invite token provided"),r("âŒ No invite token in URL"),i({title:"Invalid Link",description:"This challenge link is missing the invite token.",variant:"destructive"}),s("/challenges");return}if(!t){console.log("â„¹ï¸ CHALLENGE JOIN: User not logged in, storing token and redirecting to login"),localStorage.setItem("pendingInviteToken",h),s("/login");return}M()},handlePostLoginJoin:()=>{const a=localStorage.getItem("pendingInviteToken");t&&a&&!u&&(console.log("ðŸ”„ CHALLENGE JOIN: Found pending token after login:",a),localStorage.removeItem("pendingInviteToken"),s(`/challenge/join?token=${a}`,{replace:!0}))}}}function ce({isJoining:n,debugInfo:s}){return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsx("div",{className:"w-full max-w-md",children:e.jsx(v,{children:e.jsxs(C,{className:"p-6 text-center space-y-4",children:[e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-chichi-orange"}),e.jsx("h3",{className:"text-lg font-semibold mt-4",children:n?"Joining Challenge...":"Loading Challenge..."}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:n?"Please wait while we set up your challenge...":"Validating challenge invitation..."})]}),s&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 p-3 mt-6 rounded-lg text-left",children:e.jsxs("p",{className:"text-sm font-mono text-blue-800 break-words",children:["Debug: ",s]})})]})})})})}function de(){const n=S();return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-4",children:e.jsx(v,{className:"w-full max-w-md",children:e.jsxs(C,{className:"p-6 text-center",children:[e.jsx(N,{className:"h-12 w-12 mx-auto text-chichi-orange mb-4"}),e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Join CHICHI First"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"You need to create an account to accept this challenge invite."}),e.jsx(Y,{onClick:()=>n("/login"),className:"w-full",children:"Sign Up / Login"})]})})})}function he({challenge:n,debugInfo:s}){var d,m,x,i;const t=((d=n==null?void 0:n.challenger_profile)==null?void 0:d.username)||((m=n==null?void 0:n.challenger_profile)==null?void 0:m.name)||"Someone";return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50 p-4",children:e.jsxs(v,{className:"w-full max-w-md",children:[e.jsxs(D,{className:"text-center",children:[e.jsx(N,{className:"h-16 w-16 mx-auto text-chichi-orange mb-4"}),e.jsx(Z,{className:"text-2xl",children:"Challenge Invite!"})]}),e.jsxs(C,{className:"space-y-6",children:[e.jsxs("div",{className:"text-center space-y-3",children:[e.jsxs(q,{className:"h-20 w-20 mx-auto",children:[e.jsx(z,{src:((x=n.challenger_profile)==null?void 0:x.avatar_url)||""}),e.jsx(W,{children:((i=t[0])==null?void 0:i.toUpperCase())||"U"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-lg",children:t}),e.jsx("p",{className:"text-gray-600",children:"invited you to a"}),e.jsxs("p",{className:"text-xl font-bold text-chichi-orange",children:[n.challenge_length,"-Day Content Sprint!"]})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"h-4 w-4 text-gray-600"}),e.jsxs("span",{className:"text-sm",children:[n.challenge_length," days of content creation"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-4 text-gray-600"}),e.jsx("span",{className:"text-sm",children:"Most points wins"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4 text-gray-600"}),e.jsx("span",{className:"text-sm",children:"Complete daily tasks to earn points"})]})]}),s&&e.jsx("div",{className:"bg-blue-50 border border-blue-200 p-3 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800",children:["Debug: ",s]})}),e.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Challenge starts immediately when you accept!"})]})]})})}function ge({isOpen:n,challengerName:s,challengeDays:t}){return e.jsx(Q,{open:n,onOpenChange:()=>{},modal:!0,children:e.jsx(X,{className:"sm:max-w-md text-center bg-gradient-to-br from-green-50 to-emerald-50 border-green-200",children:e.jsxs(ee,{children:[e.jsx(ne,{className:"text-center",children:e.jsxs("div",{className:"flex flex-col items-center space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(ie,{className:"h-20 w-20 text-green-500"}),e.jsx("div",{className:"absolute inset-0 bg-green-500 rounded-full animate-ping opacity-20"})]}),e.jsx("span",{className:"text-3xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent",children:"ðŸŽ‰ CHALLENGE JOINED!"})]})}),e.jsxs(se,{className:"text-center space-y-6 pt-4",children:[e.jsxs("div",{className:"bg-white border border-green-200 p-6 rounded-xl shadow-sm",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-4",children:[e.jsx(re,{className:"h-6 w-6 text-orange-500"}),e.jsx("span",{className:"text-xl font-bold text-gray-800",children:"Battle Ready!"})]}),e.jsxs("p",{className:"text-lg text-gray-700 mb-3",children:["You're now in an epic showdown with"," ",e.jsx("span",{className:"font-bold text-chichi-orange",children:s}),"!"]}),e.jsxs("p",{className:"text-base text-gray-600 mb-4",children:["Battle duration: ",e.jsxs("span",{className:"font-semibold text-chichi-purple",children:[t," days"]})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-orange-100 to-red-100 border border-orange-200 p-4 rounded-xl",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx(N,{className:"h-6 w-6 text-chichi-orange"}),e.jsx("span",{className:"font-bold text-orange-800",children:"THE BATTLE BEGINS NOW!"})]}),e.jsx("p",{className:"text-sm font-medium text-orange-700",children:"Complete your daily CHICHI tasks to earn points and claim victory in this creator showdown!"})]}),e.jsx("p",{className:"text-sm text-gray-500 bg-gray-100 p-2 rounded-lg",children:"ðŸš€ Redirecting to your battle arena in 3 seconds..."})]})]})})})}function me(){const{user:n}=H(),{challenge:s,isLoading:t,isJoining:d,showSuccessModal:m,joinedChallengeName:x,challengeDays:i,debugInfo:u,handleTokenValidation:f,handlePostLoginJoin:j}=oe();return c.useEffect(()=>{f()},[n]),c.useEffect(()=>{j()},[n]),n?t||d?e.jsx(ce,{isJoining:d,debugInfo:u}):e.jsxs(e.Fragment,{children:[s&&e.jsx(he,{challenge:s,debugInfo:u}),e.jsx(ge,{isOpen:m,challengerName:x,challengeDays:i})]}):e.jsx(de,{})}function ve(){return e.jsx(me,{})}export{ve as default};
