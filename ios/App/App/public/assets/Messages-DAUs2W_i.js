import{r as l,u as N,s as f,q as u,j as e,C as _,c as C,d as b,I as S,f as j,aq as y,ah as M,ai as E,aj as q,an as A,v as w,T as L,B as $,aB as D}from"./index-Caw7KGCA.js";import{S as T}from"./search-ieVePH5C.js";const k=()=>{const[t,m]=l.useState([]),[o,x]=l.useState([]),[d,s]=l.useState(!0),[i,h]=l.useState(!1),{user:a}=N(),r=async()=>{if(a!=null&&a.id)try{const{data:c,error:n}=await f.rpc("get_user_conversations",{user_uuid:a.id});if(n){console.error("Error fetching conversations:",n),u({title:"Error",description:"Failed to load conversations",variant:"destructive"});return}m(c||[])}catch(c){console.error("Unexpected error fetching conversations:",c),u({title:"Error",description:"An unexpected error occurred",variant:"destructive"})}finally{s(!1)}},p=async c=>{if(a!=null&&a.id)try{const{data:n,error:g}=await f.from("user_messages").select("*").or(`and(sender_id.eq.${a.id},recipient_id.eq.${c}),and(sender_id.eq.${c},recipient_id.eq.${a.id})`).order("created_at",{ascending:!0});if(g){console.error("Error fetching messages:",g),u({title:"Error",description:"Failed to load messages",variant:"destructive"});return}x(n||[]),await f.from("user_messages").update({read_at:new Date().toISOString()}).eq("sender_id",c).eq("recipient_id",a.id).is("read_at",null),r()}catch(n){console.error("Unexpected error fetching messages:",n)}};return{conversations:t,messages:o,isLoading:d,isSending:i,fetchConversations:r,fetchMessages:p,sendMessage:async(c,n)=>{if(!(a!=null&&a.id)||!n.trim())return!1;h(!0);try{const{error:g}=await f.from("user_messages").insert({sender_id:a.id,recipient_id:c,message:n.trim()});return g?(console.error("Error sending message:",g),u({title:"Error",description:"Failed to send message",variant:"destructive"}),!1):(p(c),!0)}catch(g){return console.error("Unexpected error sending message:",g),u({title:"Error",description:"An unexpected error occurred",variant:"destructive"}),!1}finally{h(!1)}}}};function F({conversations:t,selectedConversation:m,searchTerm:o,onSearchChange:x,onSelectConversation:d}){return e.jsxs(_,{className:"lg:col-span-1",children:[e.jsxs(C,{className:"pb-3",children:[e.jsx(b,{className:"text-lg",children:"Conversations"}),e.jsxs("div",{className:"relative",children:[e.jsx(T,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4"}),e.jsx(S,{placeholder:"Search conversations...",value:o,onChange:s=>x(s.target.value),className:"pl-10"})]})]}),e.jsx(j,{className:"p-0",children:e.jsx("div",{className:"space-y-0 max-h-[400px] overflow-y-auto",children:t.length===0?e.jsxs("div",{className:"p-4 text-center text-gray-500",children:[e.jsx(y,{className:"h-8 w-8 mx-auto mb-2 text-gray-300"}),e.jsx("p",{children:"No conversations yet"}),e.jsx("p",{className:"text-sm",children:"Start messaging creators from the Connect page!"})]}):t.map(s=>e.jsx("div",{className:`p-4 cursor-pointer hover:bg-gray-50 border-b ${m===s.other_user_id?"bg-blue-50":""}`,onClick:()=>d(s.other_user_id),children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs(M,{className:"h-10 w-10",children:[e.jsx(E,{src:s.other_user_avatar_url||void 0}),e.jsx(q,{children:s.other_user_name.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:s.other_user_name}),s.unread_count>0&&e.jsx(A,{variant:"default",className:"ml-2",children:s.unread_count})]}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:s.last_message}),e.jsx("p",{className:"text-xs text-gray-400",children:w(new Date(s.last_message_date),"MMM d, h:mm a")})]})]})},s.other_user_id))})})]})}function B({selectedConversation:t,messages:m,isSending:o,onSendMessage:x}){const[d,s]=l.useState(""),{user:i}=N(),h=async()=>{d.trim()&&(await x(d),s(""))},a=r=>{r.key==="Enter"&&!r.shiftKey&&(r.preventDefault(),h())};return e.jsx(_,{className:"lg:col-span-2",children:t?e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"p-4 max-h-[400px] overflow-y-auto",children:e.jsx("div",{className:"space-y-4",children:m.map(r=>e.jsx("div",{className:`flex ${r.sender_id===(i==null?void 0:i.id)?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs lg:max-w-md px-4 py-2 rounded-lg ${r.sender_id===(i==null?void 0:i.id)?"bg-chichi-purple text-white":"bg-gray-100 text-gray-900"}`,children:[e.jsx("p",{className:"text-sm",children:r.message}),e.jsx("p",{className:`text-xs mt-1 ${r.sender_id===(i==null?void 0:i.id)?"text-purple-200":"text-gray-500"}`,children:w(new Date(r.created_at),"h:mm a")})]})},r.id))})}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(L,{value:d,onChange:r=>s(r.target.value),placeholder:"Type your message...",rows:2,className:"resize-none",onKeyDown:a}),e.jsx($,{onClick:h,disabled:o||!d.trim(),className:"bg-chichi-purple hover:bg-chichi-purple-dark",children:e.jsx(D,{className:"h-4 w-4"})})]})})]}):e.jsxs(j,{className:"p-8 text-center",children:[e.jsx(y,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No conversation selected"}),e.jsx("p",{className:"text-gray-500",children:"Choose a conversation to start messaging"})]})})}function z(){const[t,m]=l.useState(null),[o,x]=l.useState(""),{conversations:d,messages:s,isLoading:i,isSending:h,fetchConversations:a,fetchMessages:r,sendMessage:p}=k();l.useEffect(()=>{a()},[]),l.useEffect(()=>{t&&r(t)},[t]);const v=async n=>{t&&await p(t,n)},c=d.filter(n=>n.other_user_name.toLowerCase().includes(o.toLowerCase())||n.other_user_username.toLowerCase().includes(o.toLowerCase()));return i?e.jsx("div",{className:"animate-fade-in p-4 md:p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-48 mb-6"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"h-96 bg-gray-200 rounded"}),e.jsx("div",{className:"lg:col-span-2 h-96 bg-gray-200 rounded"})]})]})}):e.jsxs("div",{className:"animate-fade-in p-4 md:p-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground mb-6",children:"Messages"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]",children:[e.jsx(F,{conversations:c,selectedConversation:t,searchTerm:o,onSearchChange:x,onSelectConversation:m}),e.jsx(B,{selectedConversation:t,messages:s,isSending:h,onSendMessage:v})]})]})}export{z as default};
