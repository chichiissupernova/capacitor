  - name: Sync Capacitor
    script: |
      npx cap sync ios
  - name: Clean iOS build
    script: |
      rm -rf ios/build
      rm -rf ~/Library/Developer/Xcode/DerivedData/*
  - name: Install iOS dependencies
    script: |
      cd ios
      pod install
  - name: Build iOS app
    script: |
      cd ios
      xcodebuild -workspace App.xcworkspace \
        -scheme App \
        -configuration Release \
        -destination generic/platform=iOS \
        -archivePath build/App.xcarchive \
        clean archive \
        CODE_SIGN_IDENTITY="" \
        CODE_SIGNING_REQUIRED=NO \
        CODE_SIGNING_ALLOWED=NO

  - name: Create IPA file
    script: |
      cd ios
      xcodebuild -exportArchive \
        -archivePath build/App.xcarchive \
        -exportPath build/ \
        -exportOptionsPlist exportOptions.plist 

  cache:
    cache_paths:
      - $HOME/.npm
      - node_modules
      - ios/Pods

  artifacts:
    - ios/build/**/*.xcarchive
    - ios/build/**/*.ipa
    - build/**
    - dist/** 